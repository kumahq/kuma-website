[settings]
experimental = true # To enable installation of Go tools from source with mise.

[tools]
ruby = "3.4.7"
node = "24.11.1"
yarn = "1.22.22"
vale = "3.13.0"
shellcheck = "0.10.0"
"go:github.com/raviqqe/muffet/v2" = "v2.11.0"
shellspec = "0.28.1"

[tasks.install]
description = "Install yarn, npm packages and gems"
run = """
yarn install
bundle install
"""

[tasks.dev]
description = "Run local development server"
run = "bundle exec foreman start"

[tasks."dev:clean"]
description = "Clean then run dev server"
depends = ["clean", "dev"]

[tasks.test]
description = "Run tests"
run = "bundle exec rspec"

[tasks.build]
description = "Build website"
run = "exe/build"

[tasks.serve]
description = "Serve with netlify"
run = "yarn netlify serve"

[tasks."serve:clean"]
description = "Clean then serve"
depends = ["clean", "serve"]

[tasks.clean]
description = "Clean build artifacts"
run = """
rm -rf dist
rm -rf .netlify
rm -rf .jekyll-cache
rm -rf app/.jekyll-{cache,metadata}
"""

[tasks.kill-ports]
description = "[DEPRECATED] Show processes on ports 4000 and 3036"
run = """
echo '[DEPRECATED]: This target is deprecated because the "dev" target now correctly handles kill signals, closing these ports automatically.'
printf "  Existing Jekyll Processes on Port 4000 : %s\\n" "$(lsof -ti:4000 | tr '\\n' ' ' || echo 'None')"
printf "  Existing Vite Processes on Port 3036   : %s\\n" "$(lsof -ti:3036 | tr '\\n' ' ' || echo 'None')"
echo 'If you still want to terminate these processes, use the "kill-ports-force" target. [WARNING]: If you are using Firefox, this action may unexpectedly kill your browser processes.'
"""

[tasks.kill-ports-force]
description = "Force kill processes on ports 4000 and 3036"
run = """
JEKYLL_PROCESS=$(lsof -ti:4000) && kill -9 $JEKYLL_PROCESS || true
VITE_PROCESS=$(lsof -ti:3036) && kill -9 $VITE_PROCESS || true
"""

[tasks."links:check"]
description = "Check links on built site"
env = { LINK_CHECK_TARGET = "http://localhost:7777", EXCLUDE_EXTERNAL_LINKS = "false" }
run = '''
if [ "${EXCLUDE_EXTERNAL_LINKS}" = "true" ]; then
  EXCLUDE_EXTERNAL='--exclude '"'"'https?://(?:\[[0-9A-Fa-f:]+\]|\d{1,3}(?:\.\d{1,3}){3}|[A-Za-z0-9-]+\.[A-Za-z0-9.-]+)(:\d+)?(?:/[^\s]*)?'"'"''
else
  EXCLUDE_EXTERNAL=''
fi

muffet \
  ${LINK_CHECK_TARGET} \
  --buffer-size 8192 \
  --exclude http://127.0.0.1:7777/docs/1. \
  --exclude 127.0.0.1 \
  --exclude 'http://localhost:7777/vite-dev/*' \
  ${EXCLUDE_EXTERNAL} \
  --include 'https?://localhost(:\d+)?(?:/[^\s]*)?' \
  --header 'Accept: */*' \
  --max-connections-per-host 8 \
  --max-response-body-size 100000000 \
  --skip-tls-verification \
  --rate-limit 50 \
  --max-retries 5 \
  --timeout 100
'''

[tasks."vale:branch"]
description = "Run vale on changed files in current branch"
run = """
vale sync
git diff --name-only --diff-filter=d origin/master...HEAD | \
  grep -E '\\.(md|markdown)$' | \
  grep -v '/generated/' | \
  grep -v '/raw/' | \
  xargs -r vale
"""

[tasks."vale:version-urls"]
description = "Check for hardcoded version URLs in changed files"
run = "tools/check-version-urls.sh"

[tasks."frontmatter:validate"]
description = "Validate frontmatter in new docs files"
run = "tools/validate-frontmatter.sh"

[tasks."test:tools"]
description = "Run tool tests with shellspec"
run = "shellspec"

[tasks.shellcheck]
description = "Run shellcheck on tools/*.sh"
run = "shellcheck tools/*.sh"

[tasks.check]
description = "Run necessary checks"
depends = ["vale:branch", "vale:version-urls", "frontmatter:validate"]
