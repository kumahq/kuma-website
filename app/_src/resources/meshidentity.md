---
title: MeshIdentity
description: Resource reference for MeshIdentity, which defines how workloads in a mesh obtain their cryptographic identity using SPIFFE-compliant practices.
keywords:
  - workload identity
  - SPIFFE
  - certificate management
content_type: reference
category: resource
---

{% warning %}
This resource is experimental.
It works only on Kubernetes and requires [MeshServices](/docs/{{ page.release }}/networking/meshservice/) to be enabled.
{% endwarning %}

`MeshIdentity` is a resource that defines how workloads in a [mesh](/docs/{{ page.release }}/introduction/concepts#mesh) obtain their cryptographic identity. It separates the responsibility of issuing identities from establishing [trust](/docs/{{ page.release }}/introduction/concepts#trust), enabling {{site.mesh_product_name}} to adopt [SPIFFE](https://spiffe.io/docs/latest/spiffe-about/overview/) compliant practices while remaining flexible and easy to use.

With `MeshIdentity`, you can:

* Enable secure mTLS between services using trusted certificate authorities
* Switch identity providers without downtime, for example when migrating from built-in certificates to [SPIRE](https://spiffe.io/docs/latest/spire-about/)
* Assign different identity providers to subsets of workloads, allowing more granular control

This resource is namespaced (system-namespace only) and controls how [data plane proxies](/docs/{{ page.release }}/introduction/concepts#data-plane-proxy) receive identity certificates.

## Spec fields

### Selector

The `selector` field controls which data plane proxies a `MeshIdentity` applies to. It uses a [Kubernetes-style label selector](/docs/{{ page.release }}/policies/introduction#kubernetes-based-selectors) on [data plane proxy](/docs/{{ page.release }}/introduction/concepts#data-plane-proxy) tags.

When multiple `MeshIdentity` resources apply to the same data plane proxy, the one with the most specific selector (greatest number of matching labels) takes precedence. If two policies have selectors with the same number of labels, {{site.mesh_product_name}} compares their names lexicographicallyâ€”the policy whose name comes first alphabetically takes precedence.

**Type:** `Selector` | **Required:** No | **Default:** Empty selector (applies to nothing)

#### Data plane

Specifies the label selector for matching data plane proxies.

**Type:** `LabelSelector` | **Required:** No

### SPIFFE ID

The `spiffeID` field defines how [SPIFFE IDs](https://spiffe.io/docs/latest/spiffe-about/spiffe-concepts/) are constructed for selected data plane proxies. By default, {{site.mesh_product_name}} generates a SPIFFE ID based on the mesh and zone. With `spiffeID`, you can customize the `trustDomain` and `path` template.

**Type:** `SpiffeID` | **Required:** No

#### Trust domain

Template for constructing the SPIFFE ID trust domain. The trust domain is the root of a SPIFFE identity namespace and identifies the trust boundary within which identities are valid.

Supported variables:

* `.Mesh` - The mesh name
* `.Zone` - The zone name
* `{{ label "label-name" }}` - Any label from the data plane proxy resource

**Type:** `string` | **Required:** No | **Default:** `"{{ .Mesh }}.{{ .Zone }}.mesh.local"`

#### Path

Template for constructing the SPIFFE ID path component. The path provides additional specificity to identify a workload within a trust domain.

Supported variables:

* `.Namespace` - The Kubernetes namespace
* `.ServiceAccount` - The Kubernetes service account
* `{{ label "label-name" }}` - Any label from the data plane proxy resource

When using `{{ label "kuma.io/workload" }}` in the path template, data plane proxies selected by this `MeshIdentity` must have the `kuma.io/workload` label. This label can be provided either:

* Via a [data plane proxy token](/docs/{{ page.release }}/production/secure-deployment/dp-auth/#workload-label-in-tokens) generated with the `--workload` parameter
* Directly on the data plane proxy resource

Connections from data plane proxies lacking the required label will be rejected.

**Type:** `string` | **Required:** No | **Default:** `"/ns/{{ .Namespace }}/sa/{{ .ServiceAccount }}"`

### Provider

The `provider` field defines how identity certificates are issued. This field is required and must specify one of the supported provider types.

**Type:** `Provider` | **Required:** Yes

#### Type

Specifies the type of certificate provider.

**Type:** `string` (enum: `Bundled`, `Spire`) | **Required:** Yes

#### Bundled

Configuration for certificates generated by {{site.mesh_product_name}}'s [control plane](/docs/{{ page.release }}/introduction/concepts#control-plane), either automatically generated or supplied by the user. Required when `type` is `Bundled`.

**Type:** `Bundled` | **Required:** When `type=Bundled`

##### Mesh trust creation

Defines whether a [MeshTrust](/docs/{{ page.release }}/policies/meshtrust) resource should be automatically created from this `MeshIdentity`. When `Enabled`, the control plane automatically generates a `MeshTrust` resource with the same name as this `MeshIdentity`.

**Type:** `string` (enum: `Enabled`, `Disabled`) | **Required:** No | **Default:** `Enabled`

##### Insecure allow self-signed

Allows the use of self-signed certificates. This should only be enabled in development environments or when you understand the security implications.

**Type:** `boolean` | **Required:** No | **Default:** `false`

##### Auto-generate

Configuration for automatic CA generation by the control plane.

**Type:** `Autogenerate` | **Required:** No

###### Enabled

When `true`, the control plane automatically generates a self-signed CA and stores it. This is useful for testing and development.

**Type:** `boolean` | **Required:** No | **Default:** `false`

##### Certificate authority

Configuration for user-provided certificate authority. Use this to specify a custom CA instead of automatic generation.

**Type:** `CA` | **Required:** No

###### Certificate

[SecureDataSource](/docs/{{ page.release }}/policies/introduction#secureds) containing the CA certificate. The control plane resolves this data source at runtime.

**Type:** `SecureDataSource` | **Required:** When `ca` is specified

###### Private key

[SecureDataSource](/docs/{{ page.release }}/policies/introduction#secureds) containing the CA private key. The control plane resolves this data source at runtime.

**Type:** `SecureDataSource` | **Required:** When `ca` is specified

##### Certificate parameters

Parameters for certificate generation.

**Type:** `CertificateParameters` | **Required:** No

###### Expiry

Duration for which generated certificates are valid.

**Type:** `Duration` | **Required:** No | **Default:** `24h`

#### SPIRE

Configuration for SPIRE-based certificate delivery. Required when `type` is `Spire`. To enable SPIRE socket injection, either:

* Set [`KUMA_RUNTIME_KUBERNETES_INJECTOR_SPIRE_ENABLED`](/docs/{{ page.release }}/reference/kuma-cp#kuma-cp-configuration) environment variable on the control plane globally
* Enable it per pod by adding the `k8s.kuma.io/spire-support` label

**Type:** `Spire` | **Required:** When `type=Spire`

##### Agent

Configuration for the SPIRE agent.

**Type:** `SpireAgent` | **Required:** No

###### Timeout

Connection timeout to the socket exposed by the SPIRE agent.

**Type:** `Duration` | **Required:** No | **Default:** `1s`

## Examples

### Basic MeshIdentity with automatic generation

{% tabs %}
{% tab Kubernetes %}

```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshIdentity
metadata:
  name: identity
  namespace: {{site.mesh_namespace}}
  labels:
    kuma.io/mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      autogenerate:
        enabled: true
```

{% endtab %}
{% tab Universal %}

```yaml
type: MeshIdentity
name: identity
mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      autogenerate:
        enabled: true
```

{% endtab %}
{% endtabs %}

### MeshIdentity with custom SPIFFE ID

{% tabs %}
{% tab Kubernetes %}

{% raw %}

```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshIdentity
metadata:
  name: identity
  namespace: {{site.mesh_namespace}}
  labels:
    kuma.io/mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: "{{ .Mesh }}.{{ .Zone }}.mesh.local"
    path: "/ns/{{ .Namespace }}/sa/{{ .ServiceAccount }}"
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      certificateParameters:
        expiry: 24h
      autogenerate:
        enabled: true
```

{% endraw %}

{% endtab %}
{% tab Universal %}

{% raw %}

```yaml
type: MeshIdentity
name: identity
mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: "{{ .Mesh }}.{{ .Zone }}.mesh.local"
    path: "/ns/{{ .Namespace }}/sa/{{ .ServiceAccount }}"
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      certificateParameters:
        expiry: 24h
      autogenerate:
        enabled: true
```

{% endraw %}

{% endtab %}
{% endtabs %}

### MeshIdentity with user-provided certificate authority

{% tabs %}
{% tab Kubernetes %}

```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshIdentity
metadata:
  name: identity
  namespace: {{site.mesh_namespace}}
  labels:
    kuma.io/mesh: default
spec:
  selector:
    dataplane:
      matchLabels:
        app: my-app
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      ca:
        certificate:
          type: File
          file:
            path: /ca.crt
        privateKey:
          type: File
          file:
            path: /ca.key
```

{% endtab %}
{% tab Universal %}

```yaml
type: MeshIdentity
name: identity
mesh: default
spec:
  selector:
    dataplane:
      matchLabels:
        app: my-app
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      ca:
        certificate:
          type: File
          file:
            path: /ca.crt
        privateKey:
          type: File
          file:
            path: /ca.key
```

{% endtab %}
{% endtabs %}

### MeshIdentity with SPIRE provider

{% tabs %}
{% tab Kubernetes %}

{% raw %}

```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshIdentity
metadata:
  name: identity-spire
  namespace: {{site.mesh_namespace}}
  labels:
    kuma.io/mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: default.us-east.mesh.local
    path: "/ns/{{ .Namespace }}/sa/{{ .ServiceAccount }}"
  provider:
    type: Spire
    spire:
      agent:
        timeout: 2s
```

{% endraw %}

{% endtab %}
{% tab Universal %}

{% raw %}

```yaml
type: MeshIdentity
name: identity-spire
mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: default.us-east.mesh.local
    path: "/ns/{{ .Namespace }}/sa/{{ .ServiceAccount }}"
  provider:
    type: Spire
    spire:
      agent:
        timeout: 2s
```

{% endraw %}

{% endtab %}
{% endtabs %}

### MeshIdentity with workload label

{% tabs %}
{% tab Kubernetes %}

{% raw %}

```yaml
apiVersion: kuma.io/v1alpha1
kind: MeshIdentity
metadata:
  name: identity-workload
  namespace: {{site.mesh_namespace}}
  labels:
    kuma.io/mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: "{{ .Mesh }}.{{ .Zone }}.mesh.local"
    path: "/workload/{{ label \"kuma.io/workload\" }}"
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      autogenerate:
        enabled: true
```

{% endraw %}

{% endtab %}
{% tab Universal %}

{% raw %}

```yaml
type: MeshIdentity
name: identity-workload
mesh: default
spec:
  selector:
    dataplane:
      matchLabels: {}
  spiffeID:
    trustDomain: "{{ .Mesh }}.{{ .Zone }}.mesh.local"
    path: "/workload/{{ label \"kuma.io/workload\" }}"
  provider:
    type: Bundled
    bundled:
      meshTrustCreation: Enabled
      insecureAllowSelfSigned: true
      autogenerate:
        enabled: true
```

{% endraw %}

{% endtab %}
{% endtabs %}

## See also

* [MeshTrust](/docs/{{ page.release }}/policies/meshtrust) - Configure trust between different domains
* [MeshTLS](/docs/{{ page.release }}/policies/meshtls) - Configure TLS modes and ciphers
* [MeshTrafficPermission (experimental)](/docs/{{ page.release }}/policies/meshtrafficpermission_experimental) - Control traffic access with SPIFFE
* [Issuing Identity with MeshIdentity bundled provider](/docs/{{ page.release }}/guides/meshidentity-guide) - Guide for using MeshIdentity with bundled provider
* [Issuing Identity with MeshIdentity and Spire](/docs/{{ page.release }}/guides/meshidentity-spire-guide) - Guide for using MeshIdentity with Spire

## All options

{% schema_viewer kuma.io_meshidentitys type=crd %}
